name: Memory Benchmark - Windows Server 2025

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  benchmark-memory-2025:
    runs-on: windows-2025
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Memory Benchmark
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "MEMORY BENCHMARK - Windows Server 2025" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          
          $results = @()
          $results += "========================================="
          $results += "MEMORY BENCHMARK - Windows Server 2025"
          $results += "========================================="
          $results += "Benchmark Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"
          $results += ""
          
          # System Information
          Write-Host "Gathering system information..." -ForegroundColor Yellow
          $os = Get-CimInstance Win32_OperatingSystem
          $cs = Get-CimInstance Win32_ComputerSystem
          
          $results += "--- System Information ---"
          $results += "OS: $($os.Caption)"
          $results += "Version: $($os.Version)"
          $results += "Build: $($os.BuildNumber)"
          $results += ""
          
          # Memory Information
          Write-Host "Gathering memory information..." -ForegroundColor Yellow
          $totalMemoryGB = [math]::Round($cs.TotalPhysicalMemory / 1GB, 2)
          $freeMemoryGB = [math]::Round($os.FreePhysicalMemory / 1MB / 1024, 2)
          $usedMemoryGB = [math]::Round($totalMemoryGB - $freeMemoryGB, 2)
          $usagePercent = [math]::Round(($usedMemoryGB / $totalMemoryGB) * 100, 2)
          
          $results += "--- Memory Configuration ---"
          $results += "Total Physical Memory: $totalMemoryGB GB"
          $results += "Free Physical Memory: $freeMemoryGB GB"
          $results += "Used Physical Memory: $usedMemoryGB GB"
          $results += "Memory Usage: $usagePercent%"
          $results += ""
          
          # Memory Modules
          $results += "--- Memory Modules ---"
          $memModules = Get-CimInstance Win32_PhysicalMemory
          $moduleCount = 0
          foreach ($module in $memModules) {
            $moduleCount++
            $results += "Module $moduleCount"
            $results += "  Capacity: $([math]::Round($module.Capacity / 1GB, 2)) GB"
            $results += "  Speed: $($module.Speed) MHz"
            $results += "  Type: $($module.MemoryType)"
            $results += "  Form Factor: $($module.FormFactor)"
            $results += "  Manufacturer: $($module.Manufacturer)"
            $results += "  Part Number: $($module.PartNumber)"
            $results += ""
          }
          
          # Test 1: Small Array Allocation (10MB)
          Write-Host "Running Test 1: Small Array Allocation (10MB)..." -ForegroundColor Yellow
          $results += "--- Test 1: Small Array Allocation (10MB) ---"
          $testSize = 10MB
          $startTime = Get-Date
          
          $array = New-Object byte[] $testSize
          
          $endTime = Get-Date
          $duration = ($endTime - $startTime).TotalMilliseconds
          $results += "Size: $([math]::Round($testSize / 1MB, 2)) MB"
          $results += "Time: $([math]::Round($duration, 2)) ms"
          $results += ""
          Write-Host "  Completed in $([math]::Round($duration, 2)) ms" -ForegroundColor Green
          
          $array = $null
          [System.GC]::Collect()
          
          # Test 2: Medium Array Allocation (100MB)
          Write-Host "Running Test 2: Medium Array Allocation (100MB)..." -ForegroundColor Yellow
          $results += "--- Test 2: Medium Array Allocation (100MB) ---"
          $testSize = 100MB
          $startTime = Get-Date
          
          $array = New-Object byte[] $testSize
          
          $endTime = Get-Date
          $duration = ($endTime - $startTime).TotalMilliseconds
          $results += "Size: $([math]::Round($testSize / 1MB, 2)) MB"
          $results += "Time: $([math]::Round($duration, 2)) ms"
          $results += ""
          Write-Host "  Completed in $([math]::Round($duration, 2)) ms" -ForegroundColor Green
          
          # Test 3: Sequential Write (100MB)
          Write-Host "Running Test 3: Sequential Write (100MB)..." -ForegroundColor Yellow
          $results += "--- Test 3: Sequential Write (100MB) ---"
          $startTime = Get-Date
          
          for ($i = 0; $i -lt $array.Length; $i += 4096) {
            $array[$i] = [byte]($i % 256)
          }
          
          $endTime = Get-Date
          $duration = ($endTime - $startTime).TotalSeconds
          $throughput = [math]::Round(($testSize / 1MB) / $duration, 2)
          $results += "Size: $([math]::Round($testSize / 1MB, 2)) MB"
          $results += "Write pattern: Every 4KB"
          $results += "Time: $([math]::Round($duration, 3)) seconds"
          $results += "Throughput: $throughput MB/s"
          $results += ""
          Write-Host "  Throughput: $throughput MB/s" -ForegroundColor Green
          
          # Test 4: Sequential Read (100MB)
          Write-Host "Running Test 4: Sequential Read (100MB)..." -ForegroundColor Yellow
          $results += "--- Test 4: Sequential Read (100MB) ---"
          $startTime = Get-Date
          
          $sum = 0
          for ($i = 0; $i -lt $array.Length; $i += 4096) {
            $sum += $array[$i]
          }
          
          $endTime = Get-Date
          $duration = ($endTime - $startTime).TotalSeconds
          $throughput = [math]::Round(($testSize / 1MB) / $duration, 2)
          $results += "Size: $([math]::Round($testSize / 1MB, 2)) MB"
          $results += "Read pattern: Every 4KB"
          $results += "Time: $([math]::Round($duration, 3)) seconds"
          $results += "Throughput: $throughput MB/s"
          $results += "Checksum: $sum"
          $results += ""
          Write-Host "  Throughput: $throughput MB/s" -ForegroundColor Green
          
          $array = $null
          [System.GC]::Collect()
          
          # Test 5: Random Access Pattern
          Write-Host "Running Test 5: Random Access Pattern..." -ForegroundColor Yellow
          $results += "--- Test 5: Random Access Pattern ---"
          $testSize = 50MB
          $array = New-Object byte[] $testSize
          $random = New-Object System.Random
          
          # Fill array
          for ($i = 0; $i -lt $array.Length; $i += 4096) {
            $array[$i] = [byte]($i % 256)
          }
          
          # Random reads
          $iterations = 100000
          $startTime = Get-Date
          
          $sum = 0
          for ($i = 0; $i -lt $iterations; $i++) {
            $index = $random.Next(0, $array.Length)
            $sum += $array[$index]
          }
          
          $endTime = Get-Date
          $duration = ($endTime - $startTime).TotalSeconds
          $opsPerSec = [math]::Round($iterations / $duration, 0)
          $results += "Array size: $([math]::Round($testSize / 1MB, 2)) MB"
          $results += "Random reads: $iterations"
          $results += "Time: $([math]::Round($duration, 3)) seconds"
          $results += "Operations/sec: $opsPerSec"
          $results += ""
          Write-Host "  Operations/sec: $opsPerSec" -ForegroundColor Green
          
          $array = $null
          [System.GC]::Collect()
          
          # Test 6: Memory Copy Performance
          Write-Host "Running Test 6: Memory Copy Performance..." -ForegroundColor Yellow
          $results += "--- Test 6: Memory Copy Performance ---"
          $testSize = 50MB
          $source = New-Object byte[] $testSize
          $destination = New-Object byte[] $testSize
          
          # Fill source
          for ($i = 0; $i -lt $source.Length; $i += 1024) {
            $source[$i] = [byte]($i % 256)
          }
          
          $startTime = Get-Date
          [System.Buffer]::BlockCopy($source, 0, $destination, 0, $testSize)
          $endTime = Get-Date
          
          $duration = ($endTime - $startTime).TotalSeconds
          $throughput = [math]::Round(($testSize / 1MB) / $duration, 2)
          $results += "Size: $([math]::Round($testSize / 1MB, 2)) MB"
          $results += "Time: $([math]::Round($duration, 3)) seconds"
          $results += "Throughput: $throughput MB/s"
          $results += ""
          Write-Host "  Throughput: $throughput MB/s" -ForegroundColor Green
          
          $source = $null
          $destination = $null
          [System.GC]::Collect()
          
          # Test 7: Array.Copy Performance
          Write-Host "Running Test 7: Array.Copy Performance..." -ForegroundColor Yellow
          $results += "--- Test 7: Array.Copy Performance ---"
          $testSize = 50MB
          $source = New-Object byte[] $testSize
          $destination = New-Object byte[] $testSize
          
          $startTime = Get-Date
          [Array]::Copy($source, $destination, $testSize)
          $endTime = Get-Date
          
          $duration = ($endTime - $startTime).TotalSeconds
          $throughput = [math]::Round(($testSize / 1MB) / $duration, 2)
          $results += "Size: $([math]::Round($testSize / 1MB, 2)) MB"
          $results += "Time: $([math]::Round($duration, 3)) seconds"
          $results += "Throughput: $throughput MB/s"
          $results += ""
          Write-Host "  Throughput: $throughput MB/s" -ForegroundColor Green
          
          $source = $null
          $destination = $null
          [System.GC]::Collect()
          
          # Test 8: Garbage Collection Performance
          Write-Host "Running Test 8: Garbage Collection Performance..." -ForegroundColor Yellow
          $results += "--- Test 8: Garbage Collection Performance ---"
          
          # Create garbage
          for ($i = 0; $i -lt 1000; $i++) {
            $temp = New-Object byte[] (100KB)
          }
          
          $startTime = Get-Date
          [System.GC]::Collect()
          [System.GC]::WaitForPendingFinalizers()
          [System.GC]::Collect()
          $endTime = Get-Date
          
          $duration = ($endTime - $startTime).TotalMilliseconds
          $results += "Full GC collection time: $([math]::Round($duration, 2)) ms"
          $results += ""
          Write-Host "  GC time: $([math]::Round($duration, 2)) ms" -ForegroundColor Green
          
          # Test 9: Memory Pressure Test
          Write-Host "Running Test 9: Memory Pressure Test..." -ForegroundColor Yellow
          $results += "--- Test 9: Memory Pressure Test ---"
          $results += "Allocating multiple 10MB arrays..."
          
          $arrays = @()
          $maxArrays = 50
          $arraySize = 10MB
          
          $startTime = Get-Date
          for ($i = 0; $i -lt $maxArrays; $i++) {
            $arrays += New-Object byte[] $arraySize
            # Fill with data
            for ($j = 0; $j -lt $arraySize; $j += 4096) {
              $arrays[$i][$j] = [byte]($j % 256)
            }
          }
          $endTime = Get-Date
          
          $duration = ($endTime - $startTime).TotalSeconds
          $totalAllocated = ($maxArrays * $arraySize) / 1MB
          $throughput = [math]::Round($totalAllocated / $duration, 2)
          
          $results += "Arrays created: $maxArrays"
          $results += "Size per array: $([math]::Round($arraySize / 1MB, 2)) MB"
          $results += "Total allocated: $([math]::Round($totalAllocated, 2)) MB"
          $results += "Time: $([math]::Round($duration, 3)) seconds"
          $results += "Throughput: $throughput MB/s"
          $results += ""
          Write-Host "  Allocated $([math]::Round($totalAllocated, 2)) MB in $([math]::Round($duration, 3)) seconds" -ForegroundColor Green
          
          # Check memory after allocation
          $os = Get-CimInstance Win32_OperatingSystem
          $freeMemoryAfter = [math]::Round($os.FreePhysicalMemory / 1MB / 1024, 2)
          $results += "Free memory after test: $freeMemoryAfter GB"
          $results += ""
          
          $arrays = $null
          [System.GC]::Collect()
          
          # Final memory state
          Write-Host "Checking final memory state..." -ForegroundColor Yellow
