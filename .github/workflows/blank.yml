name: Memory Benchmark - Windows Server 2025

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  benchmark-memory-2025:
    runs-on: windows-2025
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Memory Benchmark
        shell: pwsh
        run: |
          # Download DiskSpd
          Invoke-WebRequest -Uri "https://github.com/microsoft/diskspd/releases/download/v2.1/DiskSpd.zip" -OutFile "diskspd.zip"
          Expand-Archive diskspd.zip -DestinationPath diskspd
          cd diskspd\amd64
          Write-Host "=== Sequential Read Test (128K blocks) ===" -ForegroundColor Cyan
          .\diskspd.exe -c1G -d30 -W5 -t1 -o32 -b128K -si -w0 testfile.dat
          Write-Host "`n=== Sequential Write Test (128K blocks) ===" -ForegroundColor Cyan
          .\diskspd.exe -c1G -d30 -W5 -t1 -o32 -b128K -si -w100 testfile.dat
          Write-Host "`n=== Random Read (4K blocks - IOPS) ===" -ForegroundColor Cyan
          .\diskspd.exe -c1G -d30 -W5 -t1 -o32 -b4K -si -r -w0 testfile.dat
          Write-Host "`n=== Random Write (4K blocks - IOPS) ===" -ForegroundColor Cyan
          .\diskspd.exe -c1G -d30 -W5 -t1 -o32 -b4K -si -r -w100 testfile.dat
          Write-Host "`n=== Mixed 70/30 Read/Write (4K blocks) ===" -ForegroundColor Cyan
          .\diskspd.exe -c1G -d30 -W5 -t1 -o32 -b4K -si -r -w30 testfile.dat
          # Cleanup
          Remove-Item testfile.dat -ErrorAction SilentlyContinue
